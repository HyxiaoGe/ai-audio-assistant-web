# Pre-commit 和 CI/CD 设置指南

## 快速开始

### 1. 安装开发依赖

```bash
# 安装 pre-commit（如果使用 uv）
uv sync --dev

# 或者使用 pip
pip install pre-commit black isort flake8 mypy bandit
```

### 2. 安装 pre-commit hooks

```bash
# 安装 git hooks（只需运行一次）
pre-commit install

# 验证安装
pre-commit --version
```

### 3. 测试 pre-commit

```bash
# 手动运行所有检查（在所有文件上）
pre-commit run --all-files

# 只运行特定 hook
pre-commit run black --all-files
pre-commit run isort --all-files
```

## 工作流程

### 本地开发流程

```
1. 写代码
   ↓
2. git add .
   ↓
3. git commit -m "message"
   ↓
4. pre-commit 自动运行（修复 + 检查）
   ├─ 如果通过 → 提交成功 ✅
   └─ 如果失败 → 修复问题后重新 commit ❌
   ↓
5. git push
   ↓
6. GitHub Actions CI 运行（只检查，不修复）
```

### Pre-commit 会做什么？

**自动修复的检查**：
- ✅ 移除行尾空格
- ✅ 确保文件以换行符结尾
- ✅ 修复混合换行符
- ✅ 使用 Black 格式化代码
- ✅ 使用 isort 排序 imports

**只检查不修复的**：
- ⚠️ Flake8 代码质量检查
- ⚠️ mypy 类型检查
- ⚠️ Bandit 安全扫描
- ⚠️ YAML/JSON 语法检查

## 常用命令

### Pre-commit 命令

```bash
# 手动运行所有 hooks
pre-commit run --all-files

# 更新 hooks 版本
pre-commit autoupdate

# 临时跳过 pre-commit（不推荐）
git commit --no-verify -m "message"

# 卸载 hooks
pre-commit uninstall
```

### 代码格式化

```bash
# 格式化代码
black app/ worker/ tests/

# 检查但不修改
black --check app/ worker/ tests/

# 排序 imports
isort app/ worker/ tests/

# 检查但不修改
isort --check-only app/ worker/ tests/
```

### 代码检查

```bash
# Flake8 检查
flake8 app/ worker/ tests/

# mypy 类型检查
mypy app/ worker/

# Bandit 安全检查
bandit -r app/ worker/ -c pyproject.toml
```

## GitHub Actions

推送代码到 GitHub 后，会自动运行以下检查：

1. **Pre-commit Checks** - 所有 pre-commit hooks
2. **Lint and Type Check** - Black, isort, Flake8, mypy
3. **Security Check** - Bandit 安全扫描
4. **Tests** - pytest 单元测试（如果有）

查看 CI 状态：
- 访问 GitHub 仓库的 "Actions" 标签页
- 每次 push 或 PR 都会触发

## 配置文件说明

- `.pre-commit-config.yaml` - Pre-commit hooks 配置
- `pyproject.toml` - Black, isort, mypy, pytest 配置
- `.github/workflows/ci.yml` - GitHub Actions CI 配置

## 常见问题

### Q: Pre-commit 太慢？

A: 可以只运行修改的文件：
```bash
pre-commit run  # 只检查 staged 文件
```

### Q: 想跳过某个 hook？

A: 编辑 `.pre-commit-config.yaml`，在对应 hook 下添加：
```yaml
- id: mypy
  exclude: ^path/to/exclude/
```

### Q: CI 失败了怎么办？

A:
1. 查看 GitHub Actions 的错误日志
2. 在本地运行 `pre-commit run --all-files` 重现问题
3. 修复后重新提交

### Q: 如何临时禁用所有 pre-commit？

A:
```bash
# 方法 1: 使用 --no-verify
git commit --no-verify -m "message"

# 方法 2: 临时卸载（不推荐）
pre-commit uninstall
# ... 做完事情后记得重新安装
pre-commit install
```

## 工具版本

查看配置的工具版本：
- Black: `black --version`
- isort: `isort --version`
- Flake8: `flake8 --version`
- mypy: `mypy --version`
- Pre-commit: `pre-commit --version`

## 参考资料

- [Pre-commit 官方文档](https://pre-commit.com/)
- [Black 文档](https://black.readthedocs.io/)
- [isort 文档](https://pycqa.github.io/isort/)
- [Flake8 文档](https://flake8.pycqa.org/)
- [mypy 文档](https://mypy.readthedocs.io/)
